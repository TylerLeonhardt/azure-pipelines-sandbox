stages:
  # ATTACHMENTS sample
  - stage:
    displayName: UploaderStage
    jobs:
      - job:
        displayName: UploaderJob
        steps:
          - pwsh: |
              1..1000 | % {
                $itemCreated = New-Item "$(Pipeline.Workspace)/$_.txt" -ItemType File -Value $_
                Write-Host "task.addattachment; type=myattachmenttype; name=$_; $($itemCreated.FullName)"
                Write-Host "##vso[task.addattachment type=myattachmenttype;name=$_;]$($itemCreated.FullName)"
              }
  - stage:
    dependsOn: []
    displayName: ConsumerStage
    jobs:
      - job:
        displayName: ConsumerJob
        steps:
          - pwsh: |
              1..100 | % {
                $res = irm "https://dev.azure.com/TylerLeonhardt/Azure%20Pipelines%20Playground/_apis/build/builds/$(Build.BuildId)/attachments/myattachmenttype?api-version=6.1-preview.2" -Headers @{ Authorization = "Bearer $env:SYSTEM_ACCESSTOKEN" }
                $res
                Start-Sleep -Seconds 1
              }
            env:
              SYSTEM_ACCESSTOKEN: $(System.AccessToken)

  # PIPELINE sample
  - stage:
    dependsOn: []
    displayName: UploaderStageArtifact
    jobs:
      - job:
        displayName: UploaderJobArtifact
        steps:
          - pwsh: |
              1..1000 | % {
                $itemCreated = New-Item "$(Pipeline.Workspace)/$_.txt" -ItemType File -Value $_
                Write-Host "artifact.upload; containerfolder=$_; artifactname=$_; $($itemCreated.FullName)"
                Write-Host "##vso[artifact.upload containerfolder=$_;artifactname=$_;]$($itemCreated.FullName)"
                Start-Sleep -Milliseconds 100
              }
          - publish: $(Pipeline.Workspace)/1.txt
            artifact: 1ALT
          - publish: $(Pipeline.Workspace)/2.txt
            artifact: 2ALT
  - stage:
    dependsOn: []
    displayName: ConsumerStageArtifact
    jobs:
      - job:
        displayName: ConsumerJobArtifact
        steps:
          - pwsh: |
              $gah = irm "https://dev.azure.com/TylerLeonhardt/Azure%20Pipelines%20Playground/_apis/build/builds/$(Build.BuildId)?api-version=6.0" -Headers @{ Authorization = "Bearer $env:SYSTEM_ACCESSTOKEN" }
              $gah | ConvertTo-Json

              $timeline = irm "https://dev.azure.com/TylerLeonhardt/Azure%20Pipelines%20Playground/_apis/build/builds/$(Build.BuildId)/timeline/?api-version=6.0" -Headers @{ Authorization = "Bearer $env:SYSTEM_ACCESSTOKEN" }
              $otherStageFinished = $timeline.records | ? { $_.type -eq 'stage' -and $_.state -eq 'completed' }
              while (!$otherStageFinished) {
                $res = irm "https://dev.azure.com/TylerLeonhardt/Azure%20Pipelines%20Playground/_apis/build/builds/$(Build.BuildId)/artifacts?api-version=6.0" -Headers @{ Authorization = "Bearer $env:SYSTEM_ACCESSTOKEN" }
                $res
                Start-Sleep -Seconds 5

                $timeline = irm "https://dev.azure.com/TylerLeonhardt/Azure%20Pipelines%20Playground/_apis/build/builds/$(Build.BuildId)/timeline/?api-version=6.0" -Headers @{ Authorization = "Bearer $env:SYSTEM_ACCESSTOKEN" }
                $otherStageFinished = $timeline.records ? { $_.type -eq 'stage' -and $_.state -eq 'completed' }
                Write-Host "thing: $(${otherStageFinished}?.type)"

              }
            env:
              SYSTEM_ACCESSTOKEN: $(System.AccessToken)
